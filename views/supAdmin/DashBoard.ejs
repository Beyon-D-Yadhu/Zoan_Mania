<%- include('../layouts/admin/header'); -%>

<div class="col-md-12">
  <h1 class="ms-3">Admin Dashboard</h1>
  <div class="row d-flex justify-content-center">
    <div class="col-10 mb-3 rounded d-flex justify-content-center border p-3 bg-light">
      <div class="row">
        <div class="col-12">
          <div class="">
            <select class="form-select text-center bg-secondary text-light select" onchange="fetchSalesData(this.value)" aria-label="Default select example">
              <option class="bg-light text-dark" value="1">Day</option>
              <option class="bg-light text-dark" value="2">Month</option>
              <option class="bg-light text-dark" value="3">Year</option>
            </select>
          </div>
          <h3 class="mt-4">Graph based on price</h3>
          <div class="row d-flex justify-content-center">
            <canvas id="barChart" style="width:100%;max-width:600px"></canvas>
          </div>

          <h3 class="mt-4">Graph based on sale</h3>
          <div class="row d-flex justify-content-center">
            <canvas id="lineChart" style="width:100%;max-width:600px"></canvas>
          </div>

          <!-- <h3 class="mt-4">Graph based on category sale</h3>
          <div class="row d-flex justify-content-center">
            <div id="pieChart" style="width:100%; max-width:600px; height:500px;"></div>
          </div> -->
        </div>
        <div class="bestSeller col-12 mt-4">
          <h3 class="mt-4">Best Seller Products</h3>
          <div class="p-3 bg-white border rounded" style="overflow-y: scroll; height:400px">
            <table class="table table-striped table-hover text-center">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Product Image</th>
                  <th scope="col">Product Name</th>
                  <th scope="col">Price</th>
                  <th scope="col">Sale</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach((product, i) => { %>
                  <tr>
                    <th scope="row"><%= i + 1 %></th>
                    <td><img height="50px" style="border-radius: 12px;" width="50px" src="/uploads/<%= product.Image[0] %>" alt="img"></td>
                    <td><%= product.Name %></td>
                    <td><%= product.discountedPrice %></td>
                    <td><%= product.Selled %></td>
                  </tr>
                <% }) %>

              </tbody>
            </table>

       
            
          </div>
          
        </div>
       <div class="col-md-12">
        <a href='/admin/downloadSalesReport' class="text-center btn btn-success mt-5">Download CSV</a>
        <a href="/admin/downloadSalesReportPDF" class="text-center btn btn-success mt-5">Download PDF</a>
       </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>


  function fetchSalesData(selectedOption) {
    fetch(`/admin/getSalesData/${selectedOption}`)
      .then(res => res.json())
      .then((data) => {
        const barCtx = document.getElementById('barChart').getContext('2d');
        const dataBar = {
          labels: Object.keys(data.ordersData.income),
          datasets: [{
            label: 'Sales',
            data: Object.values(data.ordersData.income),
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        };

        const configBar = {
          type: 'bar',
          data: dataBar,
          options: {
            scales: {
              y: { beginAtZero: true },
              x: { beginAtZero: true }
            }
          },
        };

        new Chart(barCtx, configBar);

        const lineCtx = document.getElementById('lineChart').getContext('2d');
        const dataLine = {
          labels: Object.keys(data.ordersData.ordered),
          datasets: [{
            fill: false,
            lineTension: 0,
            backgroundColor: 'rgba(0, 255, 255, 1.0)',
            borderColor: 'rgba(0, 255, 255, 0.4)',
            data: Object.values(data.ordersData.ordered),
          }]
        };

        const configLine = {
          type: 'line',
          data: dataLine,
          options: {
            legend: { display: false },
            scales: { yAxes: [{ ticks: { min: 0 } }] }
          }
        };

        new Chart(lineCtx, configLine);

        // google.charts.load('current', { 'packages': ['corechart'] });
        // google.charts.setOnLoadCallback(drawChart);

        // function drawChart() {
        //   const pieData = google.visualization.arrayToDataTable([
        //     ['Country', 'Mhl'],
        //     ['Italy', 54.8],
        //     ['France', 48.6],
        //     ['Spain', 44.4],
        //     ['USA', 23.9],
        //     ['Argentina', 14.5]
        //   ]);

        //   const pieOptions = {
        //     title: 'World Wide Wine Production',
        //     is3D: true
        //   };

        //   const pieChart = new google.visualization.PieChart(document.getElementById('pieChart'));
        //   pieChart.draw(pieData, pieOptions);
        // }
      })
      .catch(error => console.error('Error fetching sales data:', error));
  }

  document.addEventListener("DOMContentLoaded", function () {
  fetchSalesData(document.querySelector('select').value);
  });
</script>

<%- include('../layouts/admin/footer'); -%>
